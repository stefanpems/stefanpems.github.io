---
title: "How to verify the effective use of Customer Managed Keys"
last_modified_at: 2022-05-09T23:15:02-05:00
tags:
  - CMK
  - Azure Monitor
  - Sentinel
---

All customers data in Azure is [encrypted "at rest"](https://docs.microsoft.com/en-us/azure/security/fundamentals/encryption-atrest) on the Microsoft datacenters. By default, the keys used in the cryptographic operations are totally managed by Microsoft throughout their entire lifecycle: they are defined as "[Microsoft Managed Keys](https://docs.microsoft.com/en-us/azure/security/fundamentals/key-management)" (MMKs) (sometimes also referred as "Platform Managed Keys" or "Service Managed Keys"). 

A wide majority of Azure PaaS and IaaS services storing customers' data allows to encrypt this data by using a "[Customer Managed Key](https://docs.microsoft.com/en-us/azure/security/fundamentals/encryption-models#supporting-services)" (CMK), generated by the customer - possibly in an on premises HSM -, updated/managed by the customer, and securely transferred in Azure Key Vault (AKV) or, when supported, in an Azure Managed HSM (M-HSM) module. This enable in Azure the "[Bring Your Own Key](https://docs.microsoft.com/en-us/azure/key-vault/keys/byok-specification)" (BYOK) scenarios. Each of these PaaS/IaaS services has its own procedures and constraints for moving from MMK to CMK. 

Recently I supported customers in testing these "CMK activation procedures" for a few of these services: [Storage Accounts](https://docs.microsoft.com/en-us/azure/storage/common/customer-managed-keys-overview?msclkid=16aa21a2cfd611ecae252c93394e42f0), [VM Disks](https://docs.microsoft.com/en-us/azure/virtual-machines/disks-enable-customer-managed-keys-portal?msclkid=28fb38adcfd611ec848de7615adb36d0), [Information Protection](https://docs.microsoft.com/en-us/azure/information-protection/byok-price-restrictions) and PaaS Databases (specifically [MySQL](https://docs.microsoft.com/en-us/azure/mysql/concepts-data-encryption-mysql?msclkid=80b887a9cfd611ec85dd911de5ef65e7)). Each time, after the configuration change was made, there was a need to verify that the change was effetctive. 

Thanks to the fact that we were operating in test environments, we have always approached these post-change verifications by temporarly disabling the new CMK in AKV: as expected, this action, after a short amount of time, made it impossible to access the data managed by the specific service and, in most cases, blocked entirely the service itself. It was enough to re-enable the key to restore the operation of the service and the access to its data (for MySQL it's necessary to perform a simple additional action manually: revalidate the customer-managed key in the data encryption settings). 

In a test environment, the approach of temporaly disabling the new CMK in AKV is quite instructive also because it gives the opportunity to "touch with hands" what could be the consequences of unwanted mistakes or deliberate destructive actions in key management operations. Fortunately, AKV offers [soft delete and purge protection](https://docs.microsoft.com/en-us/azure/key-vault/general/key-vault-recovery?tabs=azure-portal) functionalities to allow recovery from this kind of incidents. In our simple tests we saw the expected behaviors:

* It was no longer possible to access the data in the Storage Account by using Storage browser
![err-storage-account](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/errstacc.png)

* It was no longer possible to start-up the Virtual Machine using the Disk Encryption Set
![err-VM](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/errvm.png)

* It was no longer possible to apply a Sensitivity Label with encryption on an email sent in OWA
![err-sensitivity-label](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/errsenslb.png)

A more generic way to test the effectiveness of the CMK configuration - clearly more adequate to production environments, where it's not possible to temporarly disable an encryption key - is by leveraging the [AKV diagnostic logging](https://docs.microsoft.com/en-us/azure/key-vault/general/logging?msclkid=3d06db48cf7911eca12c8d15f1b5f54a&tabs=Vault) capability and the power of [Azure Log Analytics](https://docs.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-overview?msclkid=55ebe7dfcfda11ecb769e24a6a323b3b). Specifically, [in the "Diagnostic settings" configuration of AKV](https://docs.microsoft.com/en-us/azure/key-vault/general/howto-logging?tabs=azure-portal), it is possible to specify that "AuditEvents" must be collected and archived in a Log Analytics workspace. 

![akv-diagnostic-settings](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/akvdiaglog.png)

The audit events generated by AKV can be identified in the "[AzureDiagnostics](https://docs.microsoft.com/en-us/azure/azure-monitor/reference/tables/azurediagnostics?msclkid=3d712f8ecfdb11ecabb3cd5648b85372)" table by filtering for the value "[MICROSOFT.KEYVAULT](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types?msclkid=60d1f554cfdb11ecbf4435db6a15071e)" in the field "ResourceProvider". The following sample KQL query shows the total number of events logged in the specified time frame by:
* Target Key Vault name, Key name and Key version
* Caller ID (the GUIDs of the Managed Identity or of the Enterprise Application accessing AKV, according to the permissions specified in the AKV data plane)
* Operation name and result

```html
{% raw %}
AzureDiagnostics
| where ResourceProvider =="MICROSOFT.KEYVAULT" 
| extend targetKeyVaultName = replace_string(tostring(split(id_s,"/")[2]),".vault.azure.net","")
| extend targetKeyName = tostring(split(id_s,"/")[4])
| extend targetKeyVersion = tostring(split(id_s,"/")[5])
| summarize count() by targetKeyVaultName, targetKeyName, targetKeyVersion, callerId = identity_claim_appid_g, OperationName, ResultSignature, ResultDescription
| project targetKeyVaultName, targetKeyName, targetKeyVersion, callerId , OperationName, ResultSignature, ResultDescription, CallsNumber = count_
| order by CallsNumber desc
{% endraw %}
```

![query1](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/query1.png)

When also the ["Diagnostic settings" section of Azure Active Directory](https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/howto-integrate-activity-logs-with-log-analytics) is configured to collect the logs of the categories "NonInteractiveUserSignInLogs" and "ManagedIdentitySignInLogs" on the same Log Analytics workspace, in the query shown above it is easy to replace the Caller ID with the name of the "managed identity" (e.g., the storage account) or "enterprise application" (e.g., Information Protection) accessing the AKV. These are the GUIDs of the identity principals added in the "[Access Policy](https://docs.microsoft.com/en-us/azure/key-vault/general/assign-access-policy?tabs=azure-portal)" page of the AKV.

The following query shows the last occurrence of successul/unsuccessful access to the Sign and Decrypt operations. Those are exacltly the accesses done or attempted by Storage Accounts, Disk Encryption Sets and Azure Information Protection for accessing their respective CMKs. 

```html
{% raw %}
AzureDiagnostics
| where ResourceProvider =="MICROSOFT.KEYVAULT" and OperationName startswith "Key" and not(OperationName == "KeyGet") 
| join kind=inner (
    AADManagedIdentitySignInLogs
        | distinct AppId, ServicePrincipalName
) 
on $left.identity_claim_appid_g == $right.AppId
| extend callerName=ServicePrincipalName
| union (
AzureDiagnostics
| where ResourceProvider =="MICROSOFT.KEYVAULT" and OperationName startswith "Key" and not(OperationName == "KeyGet") 
| join kind=inner (
    AADNonInteractiveUserSignInLogs
    | distinct ResourceIdentity, ResourceDisplayName
) 
on $left.identity_claim_appid_g == $right.ResourceIdentity
| extend callerName=ResourceDisplayName
)
| where callerName != "Microsoft Azure KeyVault portal extension" and callerName  != "Azure Key Vault" 
| extend targetKeyVaultName = replace_string(tostring(split(id_s,"/")[2]),".vault.azure.net","")
| extend targetKeyName = tostring(split(id_s,"/")[4])
| extend targetKeyVersion = tostring(split(id_s,"/")[5])
| summarize arg_max(lastCallTime=TimeGenerated, OperationName) by callerName, targetKeyVaultName, targetKeyName, targetKeyVersion, ResultSignature, ResultDescription
| order by targetKeyVaultName, targetKeyName, targetKeyVersion, ResultSignature, lastCallTime 
| project targetKeyVaultName, targetKeyName, targetKeyVersion, OperationName, ResultSignature, ResultDescription, lastCallTime, callerName 
{% endraw %}
```

![query2](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/query2.png)

Just as a side note, in my lab environment the query shown above returns a quite high number of failures due to the repeated operations of disabling keys for testing purposes. 

From a monitoring point of view, it is important to consider that [the different diagnostics and insights capabilities in AKV](https://docs.microsoft.com/en-us/azure/key-vault/general/monitor-key-vault) allow to take under continuous control the performances and failures of the existing vaults. This is an extremely important functionality, especially when AKV hosts CMKs repeatedly accessed by their corrispective Azure services.

![azure-monitor-for-AKV](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/azmon.png)

As a final tought, it's worth to remind that AKV is a ["Tier 0" service](https://docs.microsoft.com/en-us/security/compass/privileged-access-access-model), hosting the most valuable assets in the organizational IT infrastructure. Because of that, it must be carefully protected and monitored from a security perspective. In terms of security posture optimization and threat monitoring, the "[Defender for Key Vault](https://docs.microsoft.com/en-us/azure/defender-for-cloud/defender-for-key-vault-introduction?msclkid=7bdc49a5cfdf11ec92ed57d5dd838cc1)" protection plan in Microsoft Defender for Cloud allows to get actionable [recommendations](https://docs.microsoft.com/en-us/azure/defender-for-cloud/recommendations-reference?msclkid=0ece65b8cfe011ecadaa858e8a388068) on the issue to be corrected and clear [alerts](https://docs.microsoft.com/en-us/azure/defender-for-cloud/alerts-reference#alerts-azurekv) on the threats to be investigated.  

![defender-for-keyvault](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/mdckv.png)

Defender for Cloud also verify continuosly the compliance of the Azure resources againts the [Azure Security Benchmark (ASB)](https://docs.microsoft.com/en-us/security/benchmark/azure/overview). ASB includes a [specific baseline](https://docs.microsoft.com/en-us/security/benchmark/azure/baselines/key-vault-security-baseline) for AKV.

![asb-compliance-for-keyvault](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/complkv.png)

In terms of additional detection, correlation and investigation, Microsoft Sentinel offers predefined Analytic Rules, a connector, a [honeytoken solution](https://docs.microsoft.com/en-us/azure/sentinel/monitor-key-vault-honeytokens?tabs=deploy-at-scale) and a [Workbook](https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/visibility-of-azure-key-vault-activity-in-sentinel-azure-key/ba-p/2140751?msclkid=b8bbbf8ccfe011ec9a942f168fa115ad) specific for AKV protection.

The following image shows the available predefined Analytic Rules templates related to AKV. As can be deduced from their names, it is extremely important to have such detection capabilities. You may notice that one of these rules is of type "[Near Real Time](https://docs.microsoft.com/en-US/azure/sentinel/create-nrt-rules?msclkid=53e36b02cfe211ecbb6a6bc4d6a52704)" (NRT); this ensures that the detection of these "Sensitive Azure Key Vault operations" is almost immediate and the possible response actions defined for these events are also trigged almost immediately.

![sentinel-analytic-rules](https://raw.githubusercontent.com/stefanpems/stefanpems.github.io/master/assets/2022-05-09-How%20to%20verify%20the%20effective%20use%20of%20Customer%20Managed%20Keys/sentinelarkv.png)

Additional recommendations for custom Analytic Rules or Hunting queries in Sentinel can be found on the internet. For example this article containst interesting queries: [Protecting Azure Key Vault with Azure Sentinel â€“ Microsoft Sentinel 101 (learnsentinel.blog)](https://learnsentinel.blog/2021/09/09/protecting-azure-key-vault-with-azure-sentinel/)  

As always, I hope that the information provided in this post may be be useful. 
